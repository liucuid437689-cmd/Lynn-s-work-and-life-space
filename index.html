<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>My Life OS V7.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --accent-blue: #007aff;
            --accent-green: #34c759;
            --accent-orange: #ff9500;
            --accent-purple: #af52de;
            --accent-red: #ff3b30;
            --nav-height: 75px;
        }

        body {
            margin: 0; padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            padding-bottom: calc(var(--nav-height) + 30px);
        }

        /* --- å¸ƒå±€ç³»ç»Ÿ --- */
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .full-width { grid-column: span 2; }

        .card {
            background: var(--card-bg); border-radius: 20px; padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; position: relative;
        }
        .card-header {
            font-size: 12px; font-weight: 700; color: var(--text-sub);
            margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* --- æ—¥å†æ ·å¼ (æ›´æ–°) --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .cal-day-head { font-size: 10px; color: var(--text-sub); font-weight: bold; margin-bottom: 5px;}
        .cal-date { 
            font-size: 12px; height: 28px; display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; position: relative; 
        }
        /* ä¸Šç­ (ç°è‰²åœˆ) */
        .cal-work { background: #f2f2f7; color: #333; }
        /* å‡æœŸ/å‘¨æœ« (ç»¿è‰²åœˆ) */
        .cal-holiday { background: #e8fce8; color: var(--accent-green); border: 1px solid #c3e6cb; }
        /* ä»Šå¤© (æ·±è“å®å¿ƒ) */
        .cal-today { background: var(--accent-blue) !important; color: white !important; font-weight: bold; border: none; }

        /* --- å¤‡å¿˜å½• --- */
        .todo-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .todo-check { width: 18px; height: 18px; border: 1.5px solid #ddd; border-radius: 4px; cursor: pointer; flex-shrink: 0;}
        .todo-check.done { background: var(--accent-blue); border-color: var(--accent-blue); position: relative; }
        .todo-check.done::after { content: 'âœ“'; color: white; font-size: 12px; position: absolute; left: 3px; top: -1px; }
        .todo-text { font-size: 14px; flex: 1; border: none; background: transparent; }
        .todo-text.done { text-decoration: line-through; color: var(--text-sub); }

        /* --- ç¿»è¯‘ --- */
        .trans-textarea { background: #f2f2f7; border: none; padding: 10px; border-radius: 10px; font-size: 14px; width: 100%; box-sizing: border-box; resize: none; }
        #transResult {
            margin-top:10px; font-size:13px; color:#333; 
            background:#f0f7ff; padding:10px; border-radius:8px; 
            border-left:3px solid var(--accent-blue); min-height: 40px; line-height: 1.5; white-space: pre-wrap;
        }

        /* --- é€šç”¨ --- */
        select, input, textarea {
            background: #f2f2f7; border: none; padding: 10px; border-radius: 10px;
            font-size: 14px; width: 100%; box-sizing: border-box;
        }
        .btn-small { padding: 6px 12px; border-radius: 8px; border: none; color: white; font-size: 11px; font-weight: 600; cursor: pointer; }
        .btn-export { background: #5856d6; color: white; border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }

        /* --- å¯¼èˆª --- */
        .nav-bar {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 380px; height: 65px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 25px; display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 9999;
        }
        .nav-item { text-align: center; color: #bbb; font-size: 11px; font-weight: 600; cursor: pointer; }
        .nav-item.active { color: var(--accent-blue); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* åˆ·æ–°æŒ‰é’® */
        .refresh-btn { background:none; border:none; font-size:20px; cursor:pointer; color:var(--text-main); }
    </style>
</head>
<body>

    <div id="page-home" class="page active">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h1 style="margin:0; font-size:24px; font-weight:800;">My Life OS</h1>
            <button class="refresh-btn" onclick="window.location.reload()">ğŸ”„</button>
        </div>

        <div class="grid-container">
            
            <div class="card full-width" style="border-top: 4px solid var(--accent-blue)">
                <div class="card-header">
                    <span>ğŸ“… <span id="calMonthName">Calendar</span></span>
                    <span style="font-size:10px; color:#aaa;">ğŸŸ¢ä¼‘ âšªç­</span>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div class="card full-width" style="border-top: 4px solid var(--accent-red)">
                <div class="card-header">ğŸ“Œ Weekly Focus</div>
                <div id="todoContainer"></div>
                <button class="btn-small" style="background:var(--accent-red); margin-top:5px; align-self:flex-start" onclick="addTodo()">+ Add Task</button>
            </div>

            <div class="card full-width" style="border-top: 4px solid var(--accent-green)">
                <div class="card-header">ğŸ“Š Weekly Habits</div>
                <div id="habitContainer"></div>
            </div>

            <div class="card" style="border-top: 4px solid var(--accent-orange)">
                <div class="card-header">â±ï¸ Focus</div>
                <select id="timerCategory" style="margin-bottom:8px;">
                    <option value="ğŸ’¼ å·¥ä½œ">ğŸ’¼ å·¥ä½œ</option>
                    <option value="ğŸ“š å­¦ä¹ ">ğŸ“š å­¦ä¹ </option>
                    <option value="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ äº²å­">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ äº²å­</option>
                    <option value="ğŸ® å¨±ä¹">ğŸ® å¨±ä¹</option>
                </select>
                <div id="timerDisplay" style="font-size:28px; font-weight:800; text-align:center; margin:5px 0;">00:00</div>
                <button id="timerBtn" style="background:var(--accent-orange); color:white; border:none; padding:10px; border-radius:10px; font-weight:700;" onclick="toggleTimer()">Start</button>
            </div>

            <div class="card" style="border-top: 4px solid var(--accent-purple)">
                <div class="card-header">ğŸ“– Notes</div>
                <select id="noteType" onchange="toggleBook()" style="margin-bottom:5px;">
                    <option value="éšç¬”">ğŸ“ éšç¬”</option>
                    <option value="è¯»ä¹¦">ğŸ“– è¯»ä¹¦</option>
                </select>
                <input id="bookName" placeholder="ä¹¦å..." style="display:none; margin-bottom:5px;">
                <textarea id="noteInput" placeholder="è®°å½•çµæ„Ÿ..." style="flex:1; resize:none;" oninput="autoSaveNote()"></textarea>
                <button onclick="saveNote()" style="background:var(--accent-purple); color:white; border:none; border-radius:8px; padding:6px; margin-top:5px; font-weight:600;">Save</button>
            </div>

            <div class="card full-width" style="border-top: 4px solid #5856d6">
                <div class="card-header">âœï¸ Daily Review</div>
                <textarea id="dailyReviewInput" placeholder="ä»Šå¤©æœ‰ä»€ä¹ˆå€¼å¾—è®°å½•çš„ï¼Ÿ" style="height:60px; resize:none;"></textarea>
                <button onclick="saveReview()" style="background:#5856d6; color:white; border:none; border-radius:8px; padding:8px; margin-top:8px; font-weight:600;">Save Review</button>
            </div>

            <div class="card full-width" style="border-top: 4px solid var(--accent-blue)">
                <div class="card-header">ğŸŒ Translator (CN â” EN)</div>
                <textarea id="transInput" class="trans-textarea" style="height:50px;" placeholder="è¾“å…¥ä¸­æ–‡æƒ³æ³•..."></textarea>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-top:8px;">
                    <button class="btn-small" style="background:var(--accent-blue)" onclick="doTrans('oral')">å£è¯­</button>
                    <button class="btn-small" style="background:#5856d6" onclick="doTrans('email')">é‚®ä»¶</button>
                    <button class="btn-small" style="background:#1c1c1e" onclick="doTrans('ppt')">æ¼”ç¤º</button>
                </div>
                <div id="transResult">ç‚¹å‡»æŒ‰é’®ç”Ÿæˆè‹±æ–‡...</div>
            </div>

        </div>
    </div>

    <div id="page-stats" class="page">
        <h2 style="margin:10px 0;">Statistics</h2>
        <div class="card full-width">
            <div class="card-header">ğŸ•’ Time Distribution</div>
            <div style="height:250px; position:relative;">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
        <div class="card full-width" style="margin-top:15px">
             <div class="card-header">ğŸ“ˆ 7-Day Trend</div>
             <div style="height:250px; position:relative;">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <div id="page-library" class="page">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0; font-size:22px;">Library</h2>
            <button class="btn-export" onclick="exportTxt()">ğŸ“¥ å¯¼å‡º TXT</button>
        </div>
        <div id="libraryContainer"></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('home', this)"><span class="nav-icon">ğŸ </span>Home</div>
        <div class="nav-item" onclick="switchPage('stats', this)"><span class="nav-icon">ğŸ“Š</span>Stats</div>
        <div class="nav-item" onclick="switchPage('library', this)"><span class="nav-icon">ğŸ“š</span>Library</div>
        <div class="nav-item" onclick="setApiKey()"><span class="nav-icon">âš™ï¸</span>Key</div>
    </div>

<script>
    // --- 1. æ—¥å†é€»è¾‘ (å‡æœŸç‰ˆ) ---
    function initCalendar() {
        const d = new Date(), month = d.getMonth(), year = d.getFullYear();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const container = document.getElementById('calendarGrid');
        document.getElementById('calMonthName').innerText = d.toLocaleString('default', { month: 'short' }) + ' ' + year;
        
        const heads = ['S','M','T','W','T','F','S'];
        container.innerHTML = heads.map(h => `<div class="cal-day-head">${h}</div>`).join('');
        
        for(let i=0; i<firstDay; i++) container.innerHTML += `<div></div>`;
        for(let i=1; i<=daysInMonth; i++) {
            const isToday = i === d.getDate();
            const dateObj = new Date(year, month, i);
            const dayOfWeek = dateObj.getDay();
            
            // ç®€å•é€»è¾‘ï¼šå‘¨å…­æ—¥ä¸ºå‡æœŸ(ç»¿è‰²)ï¼Œå‘¨ä¸€è‡³äº”ä¸ºå·¥ä½œ(ç°è‰²)
            // å¦‚æœæ˜¯ä»Šå¤©ï¼Œè¦†ç›–ä¸ºæ·±è“è‰²
            let typeClass = (dayOfWeek === 0 || dayOfWeek === 6) ? 'cal-holiday' : 'cal-work';
            if (isToday) typeClass = 'cal-today';

            container.innerHTML += `<div class="cal-date ${typeClass}">${i}</div>`;
        }
    }

    // --- 2. å¤‡å¿˜å½•é€»è¾‘ ---
    let todos = JSON.parse(localStorage.getItem('todos_v7') || '[]');
    function renderTodos() {
        const container = document.getElementById('todoContainer');
        container.innerHTML = todos.map((t, i) => `
            <div class="todo-item">
                <div class="todo-check ${t.done?'done':''}" onclick="toggleTodo(${i})"></div>
                <input class="todo-text ${t.done?'done':''}" value="${t.text}" onchange="editTodo(${i}, this.value)">
                <span style="color:#ddd; cursor:pointer;" onclick="deleteTodo(${i})">âœ•</span>
            </div>
        `).join('');
    }
    function addTodo() { todos.push({text: '', done: false}); renderTodos(); }
    function toggleTodo(i) { todos[i].done = !todos[i].done; saveTodos(); }
    function editTodo(i, val) { todos[i].text = val; saveTodos(); }
    function deleteTodo(i) { todos.splice(i, 1); saveTodos(); }
    function saveTodos() { localStorage.setItem('todos_v7', JSON.stringify(todos)); renderTodos(); }

    // --- 3. ä¹ æƒ¯æ‰“å¡ ---
    const HABITS = ["å¤šå–æ°´ ğŸ’§", "è¿åŠ¨30min ğŸƒ", "æŠ—ç³–é¥®é£Ÿ ğŸ¬", "æç®€è¡¨è¾¾ ğŸ—£ï¸", "å¿«é€Ÿè¡ŒåŠ¨ âš¡"];
    let hData = JSON.parse(localStorage.getItem('habits_v7') || '{}');
    const getWeekKey = () => {
        const d = new Date(); d.setDate(d.getDate() - (d.getDay()||7) + 1);
        return d.toISOString().split('T')[0];
    };
    const wkKey = getWeekKey();
    if(!hData[wkKey]) hData[wkKey] = HABITS.map(() => Array(7).fill(false));

    function renderHabits() {
        const todayIdx = (new Date().getDay() || 7) - 1;
        document.getElementById('habitContainer').innerHTML = HABITS.map((name, hIdx) => `
            <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f2f2f7;">
                <div style="font-size:12px; font-weight:600; width:80px;">${name}</div>
                <div style="display:flex; gap:5px;">
                    ${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map((label, dIdx) => {
                        const done = hData[wkKey][hIdx][dIdx];
                        const active = dIdx === todayIdx;
                        return `<div onclick="toggleHabit(${hIdx},${dIdx})" style="width:26px; height:26px; border-radius:50%; border:1.5px solid ${active?'#000':'#e5e5ea'}; background:${done?'var(--accent-green)':'white'}; color:${done?'white':'#ddd'}; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:pointer; font-weight:bold;">${done?'âœ“':label}</div>`;
                    }).join('')}
                </div>
            </div>
        `).join('');
    }
    function toggleHabit(h, d) { hData[wkKey][h][d] = !hData[wkKey][h][d]; localStorage.setItem('habits_v7', JSON.stringify(hData)); renderHabits(); }

    // --- 4. ç¬”è®° & æ€»ç»“ ---
    function toggleBook() { document.getElementById('bookName').style.display = document.getElementById('noteType').value==='è¯»ä¹¦'?'block':'none'; }
    function saveNote() {
        const txt = document.getElementById('noteInput').value.trim();
        const type = document.getElementById('noteType').value;
        const book = document.getElementById('bookName').value;
        if(!txt) return;
        const content = type==='è¯»ä¹¦' ? `ğŸ“–ã€Š${book}ã€‹: ${txt}` : `ğŸ“ ${txt}`;
        const logs = JSON.parse(localStorage.getItem('logs_v7') || '[]');
        logs.unshift({type: 'note', content, date: new Date().toLocaleString()});
        localStorage.setItem('logs_v7', JSON.stringify(logs));
        document.getElementById('noteInput').value = '';
        alert('Saved!');
    }
    function saveReview() {
        const val = document.getElementById('dailyReviewInput').value.trim();
        if(!val) return;
        const logs = JSON.parse(localStorage.getItem('logs_v7') || '[]');
        logs.unshift({type: 'review', content: `âœï¸ æ€»ç»“: ${val}`, date: new Date().toLocaleDateString()});
        localStorage.setItem('logs_v7', JSON.stringify(logs));
        document.getElementById('dailyReviewInput').value = '';
        alert('Review Saved!');
    }

    // --- 5. ç¿»è¯‘ (è‹±æ–‡å¼ºåˆ¶ä¿®æ­£ç‰ˆ) ---
    async function doTrans(type) {
        const input = document.getElementById('transInput').value.trim();
        const key = localStorage.getItem('dk_v7');
        if(!input || !key) return alert("è¯·è¾“å…¥å†…å®¹å¹¶ç‚¹å‡»å³ä¸‹è§’è®¾ç½® Key");
        
        const resBox = document.getElementById('transResult');
        resBox.innerText = "Generating English...";
        
        // å…³é”®ï¼šå¼ºåˆ¶ Prompt
        const prompts = { 
            oral: "You are a native English speaker. Translate the following Chinese into natural, casual Spoken English for workplace conversations.", 
            email: "You are a business communication expert. Translate the following Chinese into professional, polite Business English suitable for emails.", 
            ppt: "You are a presentation coach. Translate the following Chinese into punchy, powerful English phrases suitable for Slide headers or bullet points." 
        };
        
        try {
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method:"POST", 
                headers:{"Content-Type":"application/json","Authorization":`Bearer ${key}`},
                body:JSON.stringify({
                    model:"deepseek-chat",
                    messages:[
                        {role:"system",content: prompts[type]},
                        {role:"user",content: "Translate this Chinese text to English: " + input}
                    ]
                })
            });
            const d = await res.json();
            resBox.innerText = d.choices[0].message.content;
        } catch(e) { resBox.innerText = "Error: API è¿æ¥å¤±è´¥"; }
    }

    // --- 6. è®¡æ—¶å™¨ & å›¾è¡¨ ---
    let tInt = null, tActive = false, tStart = 0;
    function toggleTimer() {
        if(!tActive) {
            tStart = Date.now(); tActive = true;
            tInt = setInterval(() => {
                const s = Math.floor((Date.now()-tStart)/1000);
                document.getElementById('timerDisplay').innerText = `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            }, 1000);
            document.getElementById('timerBtn').innerText = "Stop";
            document.getElementById('timerBtn').style.background = "#ff3b30";
        } else {
            clearInterval(tInt); tActive = false;
            document.getElementById('timerBtn').innerText = "Start";
            document.getElementById('timerBtn').style.background = "var(--accent-orange)";
            const recs = JSON.parse(localStorage.getItem('timer_v7') || '[]');
            recs.push({c: document.getElementById('timerCategory').value, ms: Date.now()-tStart, d: new Date().toISOString()});
            localStorage.setItem('timer_v7', JSON.stringify(recs));
        }
    }

    let pChart, bChart;
    function renderCharts() {
        const logs = JSON.parse(localStorage.getItem('timer_v7') || '[]');
        if(logs.length === 0) return;

        const cats = {}; logs.forEach(l => { cats[l.c] = (cats[l.c]||0) + l.ms; });
        const days = {}; for(let i=6;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); days[d.toISOString().split('T')[0]]=0; }
        logs.forEach(l => { const k=l.d.split('T')[0]; if(days[k]!==undefined) days[k]+=l.ms; });

        if(pChart) pChart.destroy();
        if(bChart) bChart.destroy();

        pChart = new Chart(document.getElementById('pieChart'), {
            type: 'doughnut',
            data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats).map(v=>(v/60000).toFixed(1)), backgroundColor: ['#ff9500','#007aff','#34c759','#af52de'] }] },
            options: { maintainAspectRatio: false }
        });
        bChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: Object.keys(days).map(d=>d.slice(5)), datasets: [{ label: 'Mins', data: Object.values(days).map(v=>(v/60000).toFixed(0)), backgroundColor: '#007aff' }] },
            options: { maintainAspectRatio: false, scales: {y:{beginAtZero:true}} }
        });
    }

    // --- 7. å¯¼å‡º TXT æ ¼å¼ (æ–°) ---
    function exportTxt() {
        const todos = JSON.parse(localStorage.getItem('todos_v7') || '[]');
        const logs = JSON.parse(localStorage.getItem('logs_v7') || '[]');
        const timers = JSON.parse(localStorage.getItem('timer_v7') || '[]');
        
        let txt = `MY LIFE OS - DATA BACKUP\nDate: ${new Date().toLocaleString()}\n\n`;
        
        txt += `=== ğŸ“Œ PENDING TASKS ===\n`;
        todos.forEach(t => txt += `[${t.done?'x':' '}] ${t.text}\n`);
        
        txt += `\n=== â±ï¸ FOCUS LOG ===\n`;
        timers.forEach(t => txt += `[${t.d.slice(0,10)}] ${t.c}: ${(t.ms/60000).toFixed(1)} mins\n`);
        
        txt += `\n=== ğŸ“– NOTES & REVIEWS ===\n`;
        logs.forEach(l => txt += `[${l.date}] ${l.content}\n`);

        const blob = new Blob([txt], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `LifeOS_Backup_${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
    }

    // --- é¡µé¢åˆ‡æ¢ ---
    function switchPage(p, el) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        el.classList.add('active');
        if(p === 'stats') renderCharts();
        if(p === 'library') renderLibrary();
    }
    
    function renderLibrary() {
        const logs = JSON.parse(localStorage.getItem('logs_v7') || '[]');
        document.getElementById('libraryContainer').innerHTML = logs.map(l => `
            <div class="card" style="margin-bottom:10px; border-left: 4px solid ${l.type==='review'?'#5856d6':'#af52de'}">
                <div style="font-size:14px; white-space: pre-wrap;">${l.content}</div>
                <div style="font-size:10px; color:#aaa; margin-top:5px;">${l.date}</div>
            </div>
        `).join('');
    }

    function setApiKey() { const k = prompt("Enter DeepSeek Key:"); if(k) localStorage.setItem('dk_v7', k.trim()); }

    window.onload = () => { initCalendar(); renderTodos(); renderHabits(); };
</script>
</body>
</html>